---
# buildmaster will attempt to change into fifoci
# (assuming fifoci is on the same host)
- name: Give buildmaster sudo
  copy:
    content: 'buildbot ALL=(ALL) NOPASSWD: ALL'
    dest: /etc/sudoers.d/buildbot
    mode: 0440
    validate: 'visudo -cf %s'

- name: Install buildbot-master
  apt: pkg={{ item }} state=present
  with_items:
    - buildbot
  when: ansible_os_family == 'Debian'

- name: Create build master
  sudo: yes
  sudo_user: buildbot
  command: buildbot create-master
  args:
    creates: buildbot.tac

- name: Install master.cfg
  sudo: yes
  sudo_user: buildbot
  copy: src=sadm/buildbot/master.cfg dest=~/master.cfg mode=0444

- name: Customise dolphin repository
  sudo: yes
  sudo_user: buildbot
  lineinfile:
    backup: yes
    dest: ~/master.cfg
    state: present
    regexp: ^DOLPHIN_REPO
    line: "DOLPHIN_REPO = \"{{ dolphin_repository }}\""

- name: Create bin directory
  sudo: yes
  sudo_user: buildbot
  file: path="~/bin" state=directory

- name: Install send_build.py
  sudo: yes
  sudo_user: buildbot
  copy: src=sadm/buildbot/send_build.py dest=~/bin/send_build.py mode=0755

- name: Build buildslave password file
  sudo: yes
  sudo_user: buildbot
  copy: content="{{ buildslaves_passwords | to_nice_json }}" dest=~/buildslaves-passwords.json

- name: Build users password file
  sudo: yes
  sudo_user: buildbot
  copy: content="{{ buildmaster_users_passwords | to_nice_json }}" dest=~/users-passwords.json

- name: Build changesource password file
  sudo: yes
  sudo_user: buildbot
  copy: content={{ changesource_password }} dest=~/changesource-password.txt

- name: Build webauth password file
  sudo: yes
  sudo_user: buildbot
  copy: content={{ webauth_password }} dest=~/webauth-password.txt

- name: Enable buildmaster init.d
  template: src=etc_default_buildmaster.j2 dest=/etc/default/buildmaster backup=yes mode=0444
  when: ansible_os_family == 'Debian'

- name: Enable nginx proxy
  template: src=buildbot.nginx.j2 dest=/etc/nginx/services/buildbot.nginx mode=0444
  when: ansible_os_family == 'Debian'

- name: Start buildmaster
  service: name=buildmaster state=started enabled=yes pattern=/usr/bin/buildbot

