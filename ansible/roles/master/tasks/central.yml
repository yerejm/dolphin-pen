---
##
## USER
##
- name: central | Add central user
  user:
    name: central
    state: present
    shell: /bin/bash
    home: /home/central

- name: central | Add public key to login as central
  authorized_key:
    user: central
    key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

##
## APT DEPENDENCIES
##
- name: central | Install central dependencies
  apt:
    pkg: "{{ item }}"
    state: present
  with_items:
    - python3
    - python3-pip
    - supervisor

##
## DEPLOY
##
- name: central | Install central
  sudo: yes
  sudo_user: central
  copy:
    src: sadm/central/
    dest: ~/

##
## PIP DEPENDENCIES
##
- name: central | Get central requirements
  sudo: yes
  sudo_user: central
  copy:
    src: sadm/central/requirements.txt
    dest: /home/central/requirements.txt

- name: central | Install central dependencies (pip requirements)
  pip:
    executable: pip3
    requirements: /home/central/requirements.txt

##
## WEB
##
- name: central | Install configuration file
  sudo: yes
  sudo_user: central
  template:
    src: central_config.yml.j2
    dest: ~/config.yml

  # shell: "nohup nice python3 central.py --config config.yml --no_local_logging >central.log 2>&1 &"

- name: central | Install the supervisor configuration file
  template:
    src: supervisor.central.conf.j2
    dest: /etc/supervisor/conf.d/central.conf
    mode: 0444
  notify: restart supervisor

- name: central | Enable nginx proxy
  template:
    src: central.nginx.j2
    dest: /etc/nginx/services/central.nginx
    mode: 0444
  notify: restart nginx

